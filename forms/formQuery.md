# LeafFormQuery Documentation

## Table of Contents

*   [Overview](#overview)
*   [Methods](#methods)
    *   [addTerm(id, operator, match, gate)](#addtermid-operator-match-gate)
    *   [addDataTerm(id, indicatorID, operator, match, gate)](#adddatatermid-indicatorid-operator-match-gate)
    *   [importQuery(queryObject)](#importqueryqueryobject)
    *   [setLimit(offset, limit)](#setlimitoffset-limit)
    *   [setLimitOffset(offset)](#setlimitoffsetoffset)
    *   [join(table)](#jointable)
    *   [getData(indicatorID)](#getdataindicatorid)
    *   [sort(column, direction)](#sortcolumn-direction)
    *   [updateTerm(id, operator, match, gate)](#updatetermid-operator-match-gate)
    *   [updateDataTerm(id, indicatorID, operator, match, gate)](#updatedatatermid-indicatorid-operator-match-gate)
    *   [setExtraParams(params)](#setextraparamsparams)
    *   [setRootURL(url)](#setrooturlurl)
    *   [onSuccess(funct)](#onsuccessfunct)
    *   [onProgress(funct)](#onprogressfunct)
    *   [setAbortSignal(signal)](#setabortsignal-signal)
    *   [execute()](#execute)


## Overview

`LeafFormQuery` is a globally available object on LEAF sites, providing an interface for querying data via the `./api/form/query` endpoint. It offers features like automatic query splitting for improved UX, progress reporting, programmatic query building, and abort signal support.

## Methods

### `addTerm(id, operator, match, gate)`

Adds a new search term.

*   `id`: (string, required, must be one of the valid IDs listed below) The column ID to search.
*   `operator`: (string, required, must be one of the valid operators listed below) The SQL comparison operator.

| Valid ID      | Supported Operators | Supported Match Terms |
|---------------|---------------------|-----------------------|
| recordID      | =, !=, >, >=, <, <=  | N/A                   |
| recordIDs     | =                   | IN clause             |
| serviceID     | =, !=, >, >=, <, <=  | N/A                   |
| submitted     | =, !=, >, >=, <, <=  | N/A                   |
| deleted       | =, !=, >, >=, <, <=  | N/A                   |
| title         | =, !=, >, >=, <, <=, LIKE, NOT LIKE | N/A                   |
| userID        | =, !=, >, >=, <, <=  | N/A                   |
| date          | =, <=, >             | strtotime             |
| dateInitiated | =, <=, >             | strtotime             |
| dateSubmitted | =, <=, >             | strtotime             |
| categoryID    | =, !=                | N/A                   |
| stepID        | =, !=                | submitted, notSubmitted, deleted, notDeleted, resolved, notResolved, actionable, or a numeric step ID |

### `addDataTerm(id, indicatorID, operator, match, gate)`

Adds a new search term specifically for data tables.

*   `id`: (string, required, must be one of the valid IDs listed below) Column ID or 'data' to search data table or 'dependencyID' to search records\_dependencies data, matching on 'filled'.
*   `indicatorID`: (string|number, required) Indicator ID or dependency ID. Use "0" to search all indicators.
*   `operator`: (string, required, must be one of the valid operators listed below) The SQL comparison operator.
*   `match`: (string) The value to search for.
*   `gate`: (string, optional, default: "AND") The logical gate ("AND" or "OR") to combine with the next term.

| Valid ID | Supported Operators | Supported Match Terms |
|---|---|---|
| data | =, !=, >, >=, <, <=, LIKE, NOT LIKE, MATCH, NOT MATCH, MATCH ALL | N/A |
| dependencyID | =, != | N/A |

### `importQuery(queryObject)`

Imports a query object generated by `formSearch`.

*   `queryObject`: (object) A JSON object with `terms`, `joins`, and `getData` arrays.  `getData` is renamed internally to avoid conflicts.

**Example:**

```javascript
const queryData = {
  terms: [],
  joins: ['service'],
  getData: [1, 2, 3]
};
formQuery.importQuery(queryData);
```
### `setLimit(offset, limit)`

Sets the query limit.

*   `offset`: (number, optional, default: 50) The offset for pagination.
*   `limit`: (number, optional) The maximum number of results to return. If only `offset` is provided, it's used as the limit.

**Example:**

```javascript
formQuery.setLimit(100, 20); // Set offset to 100 and limit to 20
formQuery.setLimit(50); // Set both offset and limit to 50
```
### `setLimitOffset(offset)`

Sets the query limit offset.

*   `offset`: (number, optional, default: 50) The offset for pagination.

**Example:**

```javascript
formQuery.setLimitOffset(25); // Set the offset to 25
```
### `join(table)`

Adds a table to join to the query.

*   `table`: (string, optional, default: "") The name of the table to join.

**Valid Options:**

*   `service`: Joins the `services` table.
*   `status`: Joins the `records_workflow_state` and `workflow_steps` tables.
*   `categoryName`: Joins the `category_count` table.
*   `categoryNameUnabridged`: Joins the `category_count` table, including disabled categories.
*   `recordsDependencies`: Joins the `records_dependencies` table.
*   `action_history`: Joins the `action_history` and related tables.
*   `stepFulfillment`: Joins the `records_step_fulfillment` and `workflow_steps` tables.
*   `stepFulfillmentOnly`: Joins the `records_step_fulfillment` table.
*   `recordResolutionData`: Joins tables related to record resolution data.
*   `recordResolutionBy`: Joins tables related to record resolution by user.
*   `initiatorName`: Joins tables to retrieve initiator name information.
*   `destructionDate`: Joins tables related to destruction date information.
*   `unfilledDependencies`: Joins tables related to unfilled dependencies.

**Example:**

```javascript
formQuery.join('service'); // Join the services table
formQuery.join('status'); // Join the status table
```
### `getData(indicatorID)`

Includes data associated with an indicator ID in the result set.

*   `indicatorID`: (string|number|array) The indicator ID(s) to include.

**Example:**

```javascript
formQuery.getData(123); // Include data for indicator ID 123
formQuery.getData([1, 2, 3]); // Include data for indicator IDs 1, 2, and 3
```
### `sort(column, direction)`

Sorts the results.

*   `column`: (string, optional, default: "date") The column to sort by.
*   `direction`: (string, optional, default: "DESC") The sort direction ("ASC" or "DESC").

**Example:**

```javascript
formQuery.sort('date', 'ASC'); // Sort by date in ascending order
formQuery.sort('title'); // Sort by title in descending order (default)
```
### `updateTerm(id, operator, match, gate)`

Updates an existing search term.

*   `id`: (string) The column ID of the term to update.
*   `operator`: (string) The SQL comparison operator.
*   `match`: (string) The new search term.
*   `gate`: (string) The logical gate.

**Example:**

```javascript
formQuery.updateTerm('title', '=', 'New Example Title', 'AND'); // Update the title term
```
### `updateDataTerm(id, indicatorID, operator, match, gate)`

Updates an existing data search term.

*   `id`: (string) The column ID of the term to update.
*   `indicatorID`: (string) The indicator ID.
*   `operator`: (string) The SQL comparison operator.
*   `match`: (string) The new search term.
*   `gate`: (string) The logical gate.

**Example:**

```javascript
formQuery.updateDataTerm('data', 0, '=', 'New Data Value', 'AND'); // Update the data term
```
### `setExtraParams(params)`

Adds extra parameters to the end of the query API URL.

*   `params`: (string) The extra parameters to add.

**Example:**

```javascript
formQuery.setExtraParams('&sort=date'); // Add a sort parameter to the URL
```
### `setRootURL(url)`

Sets the root URL for the API endpoint.

*   `url`: (string) The root URL.

**Example:**

```javascript
formQuery.setRootURL('https://api.example.com'); // Set the root URL
```
### `onSuccess(funct)`

Sets a success callback function.

*   `funct`: (function) The callback function to be called on success.  Receives `result`, `textStatus`, and `jqXHR` as arguments.

**Example:**

```javascript
formQuery.onSuccess(function(result) {
  console.log('Query successful:', result);
});
```
### `onProgress(funct)`

Sets a progress callback function.

*   `funct`: (function) The callback function to be called on each batch of data processed. Receives the progress (number of records processed) as an argument.

**Example:**

```javascript
formQuery.onProgress(function(progress) {
  console.log('Query progress:', progress);
});
```
### `setAbortSignal(signal)`

Sets an AbortSignal to cancel the query.

*   `signal`: (AbortSignal) The AbortSignal object.

**Example:**

```javascript
const abortController = new AbortController();
formQuery.setAbortSignal(abortController.signal);

// Later, to abort the query:
abortController.abort();
```
### `execute()`

Executes the query and returns a Promise resolving to the query response.

**Example:**

```javascript
formQuery.execute()
  .then(function(result) {
    console.log('Query result:', result);
  })
  .catch(function(error) {
    console.error('Query error:', error);
  });
```
