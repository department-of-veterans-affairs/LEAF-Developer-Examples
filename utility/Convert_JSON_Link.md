# Convert JSON Report URL
This tool is used when you only have a JSON endpoint generated by the Report Builder, and want to modify the query in the Report Builder.

```html
<style>
#content {
    margin: 1rem;
}
</style>
<h1>Convert JSON URL (BETA)</h1>
<p>This tool simplifies the process of modifying queries.</p>
<p>LEAF JSON URL: <input type="text" id="url" style="width: 30rem"/> <button class="buttonNorm" id="btn_transform">Transform</button></p>

<p id="output"></p>

<script>
function buildReportLink(baseURL, query, indicators) {
    console.log(baseURL, query, indicators);
    let urlQuery = LZString.compressToBase64(JSON.stringify(query));
    let urlIndicators = LZString.compressToBase64(JSON.stringify(indicators));
    return baseURL + '?a=reports&v=3&query=' + encodeURIComponent(urlQuery) + '&indicators=' + encodeURIComponent(urlIndicators);
}

// removeAuthURL replaces the auth domain with the standard leaf domain
function removeAuthURL(url) {
    return url.replace('https://auth.leaf.va.gov/report_auth.php?r=', 'https://leaf.va.gov');
}

// getBaseURL returns the base LEAF url for any given LEAF url
function getBaseURL(url) {
    if(url.indexOf('/admin/') != -1) {
        return url.substring(0, url.indexOf('/admin/') + 1);
    }
    else if(url.indexOf('/?') != -1) {
        return url.substring(0, url.indexOf('/?') + 1);
    }
    else if(url.indexOf('/index.php?') != -1) {
        return url.substring(0, url.indexOf('/index.php?') + 1);
    }
    else if(url.indexOf('/report.php?') != -1) {
        return url.substring(0, url.indexOf('/report.php?') + 1);
    }
    else if(url.indexOf('/api/open/form/query/') != -1) {
        return url.substring(0, url.indexOf('/api/open/form/query/') + 1);
    }
    else if(url.indexOf('/open.php?') != -1) {
        return url.substring(0, url.indexOf('/open.php?') + 1);
    }
    return null;
}

// getIndicatorMap returns a map of indicatorID -> name
async function getIndicatorMap(baseUrl) {
    let resIndicators = await fetch(baseUrl + 'api/form/indicator/list?x-filterData=indicatorID,name,description');
    let indicators = await resIndicators.json();
    let data = {};
    for(let i in indicators) {
        data[indicators[i].indicatorID] = indicators[i].name;
        if(indicators[i].description != null && indicators[i].description != '') {
            data[indicators[i].indicatorID] = indicators[i].description;
        }
    }
    return data;
}

async function main() {
    document.querySelector('title').innerText = 'Convert LEAF JSON URL';

    document.querySelector('#btn_transform').addEventListener('click', async function() {
    	let url = document.querySelector('#url').value;
        let standardUrl = removeAuthURL(url);
        let baseUrl = getBaseURL(standardUrl);

    	let query = {};
    	let indicatorMap = {};
    	await Promise.all([
            fetch(standardUrl + '?debug').then(res => res.json()),
            getIndicatorMap(baseUrl)
        ]).then(data => {
        	query = data[0];
            indicatorMap = data[1];
        });
    	
    	let indicators = [{indicatorID: 'title'}];
    
    	// convert join terms to header names used in Report Builder
    	if(query.joins != undefined) {
            query.joins.forEach(join => {
                let temp = {};
                temp.indicatorID = join;
                switch(join) {
                    case 'service':
                        temp.indicatorID = 'service';
                        break;
                    case 'categoryName':
                        temp.indicatorID = 'type';
                        break;
                    case 'status':
                        temp.indicatorID = 'status';
                        break;
                    case 'initiatorName':
                        temp.indicatorID = 'initiator';
                        break;
                    case 'recordResolutionData':
                        temp.indicatorID = 'dateResolved';
                        break;
                    case 'recordResolutionBy':
                        temp.indicatorID = 'resolvedBy';
                        break;
                    case 'approval_history':
                        temp.indicatorID = 'action_history';
                        break;
                }
                indicators.push(temp);
            });
        }
    	if(query.getData != undefined) {
            query.getData.forEach(id => {
                let temp = {};
                temp.indicatorID = id;
                if(indicatorMap[id] != undefined) {
                	temp.name = indicatorMap[id];
                	indicators.push(temp);
                }
            });
        }

    	let reportLink = buildReportLink(baseUrl, query, indicators);
    	document.querySelector('#output').innerHTML = `<a href="${reportLink}" target="_blank">${reportLink}</a>`;
    });
}

document.addEventListener('DOMContentLoaded', main);
</script>
```
